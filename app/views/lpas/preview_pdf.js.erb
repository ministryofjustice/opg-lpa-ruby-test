/*jslint browser: true, evil: false, plusplus: true, white: true, indent: 2 */
/*global alert, Poller, $ */

(function(){
  'use strict';

  // get id of LPAs
  var $link = $('#content').find('.js-preview-pdf'),
      fallback = function () {
        alert('Unfortunately your PDF could not be generated, please try again.');
        $link
          .unbind('click')
          .text($link.data('title'))
          .removeData('title')
          .spinner('off');
      };

  // create loading animation
  $link
    .spinner({placement: 'before'})
    .blur()
    .data('title', $link.text())
    .text('Generating PDF')
    .click(function() {
      return false;
    });

  // create new polling object
  var poller = new Poller({
    url: '<%=j lpa_get_pdf_path %>',
    onSuccess: function (response) {
      // redirect to PDF
      window.location = response.pdfURL;
    },
    onMaxAttempts: fallback,
    onMaxFails: fallback
  });
  // start polling
  poller.init();
})();
