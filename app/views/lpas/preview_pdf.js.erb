/*jslint browser: true, evil: false, plusplus: true, white: true, indent: 2 */
/*global Poller, $ */

(function(){
  'use strict';

  // get id of LPAs
  var lpa_id = '<%=j @lpa_id %>',
      $link = $('#content').find('.js-preview-pdf'),
      fallback = function (response) {
        $link
          .unbind('click')
          .text($link.data('title'))
          .removeData('title')
          .spinner('off');
      };

  // create loading animation
  $link
    .spinner({placement: 'before'})
    .blur()
    .data('title', $link.text())
    .text('Generating PDF')
    .click(function() {
      return false;
    });

  // create new polling object
  var poller = new Poller({
    url: '/lpas/' + lpa_id + '/get_pdf',
    data: {lpa_id: lpa_id},
    maxAttempts: 3,
    onSuccess: function (response) {
      // redirect to PDF
      window.location = response.pdfURL;
    },
    onMaxAttempts: fallback,
    onMaxFails: fallback
  });
  // start polling
  poller.init();
})();
